<% if notice %>
  <div class="flash-notice"><%= notice %></div>
<% end %>

<% if alert %>
  <div class="flash-alert"><%= alert %></div>
<% end %>

<div class="breadcrumb">
  <%= link_to "‚Üê Back to Dashboard", root_path, class: "back-link" %>
</div>

<div class="page-header">
  <h1>‚öôÔ∏è System Configuration</h1>
  <p>Configure terminology and features for your inventory system</p>
</div>

<div class="settings-container">
  <div class="current-config">
    <h2>Current Configuration</h2>
    <div class="config-summary">
      <div class="config-item">
        <strong>App Title:</strong> <%= @current_config.app_title %>
      </div>
      <div class="config-item">
        <strong>Location Term:</strong> <%= location_term %> / <%= location_term(plural: true) %>
      </div>
      <div class="config-item">
        <strong>Location Emoji:</strong> <%= location_emoji %>
      </div>
      <div class="config-item">
        <strong>Aging Enabled:</strong> <%= aging_enabled? ? 'Yes' : 'No' %>
      </div>
      <% if aging_enabled? %>
        <div class="config-item">
          <strong>Warning Threshold:</strong> <%= aging_threshold(:warning) %> days
        </div>
        <div class="config-item">
          <strong>Danger Threshold:</strong> <%= aging_threshold(:danger) %> days
        </div>
      <% end %>
      <div class="config-item">
        <strong>Current Preset:</strong>
        <span class="preset-badge <%= @current_preset == :custom ? 'custom' : 'preset' %>">
          <%= @current_preset.to_s.humanize %>
        </span>
      </div>
    </div>
  </div>

  <div class="preset-selection">
    <h2>Industry Presets</h2>
    <p>Choose a preset that matches your industry or use case:</p>

    <%= form_with url: settings_path, method: :patch, local: true, class: "preset-form" do |f| %>
      <div class="presets-grid">
        <% @presets.each do |preset_name, preset_config| %>
          <div class="preset-card <%= 'active' if @current_preset == preset_name %>">
            <div class="preset-header">
              <h3><%= preset_config[:location_emoji] %> <%= preset_name.to_s.humanize %></h3>
              <div class="preset-details">
                <strong>App Title:</strong> <%= preset_config[:app_title] %><br>
                <strong>Locations:</strong> <%= preset_config[:location_singular] %> / <%= preset_config[:location_plural] %><br>
                <strong>Aging:</strong> <%= preset_config[:aging_enabled] ? 'Enabled' : 'Disabled' %>
                <% if preset_config[:aging_enabled] %>
                  (Warning: <%= preset_config[:aging_warning_days] %>d, Danger: <%= preset_config[:aging_danger_days] %>d)
                <% end %>
              </div>
            </div>
            <div class="preset-actions">
              <% if @current_preset == preset_name %>
                <button type="button" class="btn btn-success" disabled>‚úì Active</button>
              <% else %>
                <%= f.submit "Apply #{preset_name.to_s.humanize}",
                    name: 'preset',
                    value: preset_name,
                    class: "btn btn-primary",
                    confirm: "This will change your system terminology and settings. Continue?" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="custom-configuration">
    <h2>Custom Configuration</h2>
    <p>Create your own custom configuration by setting each value individually:</p>

    <%= form_with url: settings_path, method: :patch, local: true, class: "custom-config-form" do |f| %>
      <div class="custom-config-grid">

        <div class="config-section">
          <h3>Basic Settings</h3>

          <div class="form-group">
            <%= label_tag 'custom_config[app_title]', 'App Title', class: 'form-label' %>
            <%= text_field_tag 'custom_config[app_title]', @current_config.app_title,
                class: 'form-input', placeholder: 'e.g., My Inventory System' %>
          </div>

          <div class="form-group">
            <%= label_tag 'custom_config[location_singular]', 'Location Term (Singular)', class: 'form-label' %>
            <%= text_field_tag 'custom_config[location_singular]', @current_config.location_singular,
                class: 'form-input', placeholder: 'e.g., Fridge, Warehouse, Store' %>
          </div>

          <div class="form-group">
            <%= label_tag 'custom_config[location_plural]', 'Location Term (Plural)', class: 'form-label' %>
            <%= text_field_tag 'custom_config[location_plural]', @current_config.location_plural,
                class: 'form-input', placeholder: 'e.g., Fridges, Warehouses, Stores' %>
          </div>

          <div class="form-group">
            <%= label_tag 'custom_config[location_emoji]', 'Location Emoji', class: 'form-label' %>
            <%= text_field_tag 'custom_config[location_emoji]', @current_config.location_emoji,
                class: 'form-input emoji-input', placeholder: 'e.g., üè¢, üè≠, üè™' %>
          </div>

          <div class="form-group">
            <%= label_tag 'custom_config[item_context]', 'Item Context', class: 'form-label' %>
            <%= text_field_tag 'custom_config[item_context]', @current_config.item_context,
                class: 'form-input', placeholder: 'e.g., frozen, warehouse, retail' %>
          </div>
        </div>

        <div class="config-section">
          <h3>Aging Settings</h3>

          <div class="form-group">
            <div class="checkbox-wrapper">
              <%= check_box_tag 'custom_config[aging_enabled]', '1', @current_config.aging_enabled,
                  id: 'aging_enabled', class: 'form-checkbox' %>
              <%= label_tag 'aging_enabled', 'Enable Aging Tracking', class: 'checkbox-label' %>
            </div>
            <small class="help-text">Track how long items have been stored and show aging indicators</small>
          </div>

          <div id="aging-options" style="<%= 'display: none;' unless @current_config.aging_enabled %>">
            <div class="form-group">
              <%= label_tag 'custom_config[aging_warning_days]', 'Warning Threshold (Days)', class: 'form-label' %>
              <%= number_field_tag 'custom_config[aging_warning_days]', @current_config.aging_warning_days,
                  class: 'form-input', min: 1, max: 9999 %>
            </div>

            <div class="form-group">
              <%= label_tag 'custom_config[aging_danger_days]', 'Danger Threshold (Days)', class: 'form-label' %>
              <%= number_field_tag 'custom_config[aging_danger_days]', @current_config.aging_danger_days,
                  class: 'form-input', min: 1, max: 9999 %>
            </div>

            <div class="form-group">
              <%= label_tag 'custom_config[aging_fresh_label]', 'Fresh Label', class: 'form-label' %>
              <%= text_field_tag 'custom_config[aging_fresh_label]', @current_config.aging_fresh_label,
                  class: 'form-input', placeholder: 'e.g., fresh, new, recent' %>
            </div>

            <div class="form-group">
              <%= label_tag 'custom_config[aging_warning_label]', 'Warning Label', class: 'form-label' %>
              <%= text_field_tag 'custom_config[aging_warning_label]', @current_config.aging_warning_label,
                  class: 'form-input', placeholder: 'e.g., getting old, aging, older' %>
            </div>

            <div class="form-group">
              <%= label_tag 'custom_config[aging_danger_label]', 'Danger Label', class: 'form-label' %>
              <%= text_field_tag 'custom_config[aging_danger_label]', @current_config.aging_danger_label,
                  class: 'form-input', placeholder: 'e.g., very old, expired, stale' %>
            </div>
          </div>
        </div>
      </div>

      <div class="custom-config-actions">
        <%= f.submit "Apply Custom Configuration", class: "btn btn-primary",
            confirm: "This will override your current settings with the custom values above. Continue?" %>
        <button type="button" id="reset-to-current" class="btn btn-secondary">Reset to Current</button>
      </div>
    <% end %>
  </div>
</div>

<style>
.settings-container {
  max-width: 1000px;
  margin: 0 auto;
}

.current-config {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 30px;
}

.config-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.config-item {
  padding: 10px;
  background: white;
  border-radius: 4px;
  border-left: 4px solid #007bff;
}

.preset-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.9em;
  font-weight: bold;
}

.preset-badge.preset {
  background: #d4edda;
  color: #155724;
}

.preset-badge.custom {
  background: #fff3cd;
  color: #856404;
}

.presets-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.preset-card {
  border: 2px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  background: white;
  transition: all 0.2s ease;
}

.preset-card:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0,123,255,0.1);
}

.preset-card.active {
  border-color: #28a745;
  background: #f8fff9;
}

.preset-header h3 {
  margin: 0 0 10px 0;
  color: #495057;
}

.preset-details {
  font-size: 0.9em;
  color: #6c757d;
  line-height: 1.4;
  margin-bottom: 15px;
}

.preset-actions {
  text-align: center;
}

.custom-configuration {
  margin-top: 40px;
  padding-top: 30px;
  border-top: 2px solid #dee2e6;
}

.custom-config-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin: 20px 0;
}

.config-section {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
}

.config-section h3 {
  margin: 0 0 20px 0;
  color: #495057;
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 10px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
  color: #495057;
}

.form-input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 14px;
}

.form-input:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.emoji-input {
  width: 60px;
  text-align: center;
  font-size: 18px;
}

.checkbox-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.form-checkbox {
  width: auto;
}

.checkbox-label {
  margin: 0;
  font-weight: 600;
}

.help-text {
  display: block;
  color: #6c757d;
  font-size: 12px;
  margin-top: 4px;
}

.custom-config-actions {
  text-align: center;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #dee2e6;
}

.custom-config-actions .btn {
  margin: 0 10px;
}

@media (max-width: 768px) {
  .custom-config-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle aging enabled checkbox
  const agingEnabledCheckbox = document.getElementById('aging_enabled');
  const agingOptions = document.getElementById('aging-options');

  function toggleAgingOptions() {
    if (agingEnabledCheckbox.checked) {
      agingOptions.style.display = 'block';
    } else {
      agingOptions.style.display = 'none';
    }
  }

  agingEnabledCheckbox.addEventListener('change', toggleAgingOptions);

  // Handle reset to current button
  document.getElementById('reset-to-current').addEventListener('click', function() {
    if (confirm('Reset all custom fields to current configuration values?')) {
      // Reset all form fields to current config values
      document.querySelector('input[name="custom_config[app_title]"]').value = '<%= j @current_config.app_title %>';
      document.querySelector('input[name="custom_config[location_singular]"]').value = '<%= j @current_config.location_singular %>';
      document.querySelector('input[name="custom_config[location_plural]"]').value = '<%= j @current_config.location_plural %>';
      document.querySelector('input[name="custom_config[location_emoji]"]').value = '<%= j @current_config.location_emoji %>';
      document.querySelector('input[name="custom_config[item_context]"]').value = '<%= j @current_config.item_context %>';
      document.querySelector('input[name="custom_config[aging_enabled]"]').checked = <%= @current_config.aging_enabled %>;
      document.querySelector('input[name="custom_config[aging_warning_days]"]').value = '<%= @current_config.aging_warning_days %>';
      document.querySelector('input[name="custom_config[aging_danger_days]"]').value = '<%= @current_config.aging_danger_days %>';
      document.querySelector('input[name="custom_config[aging_fresh_label]"]').value = '<%= j @current_config.aging_fresh_label %>';
      document.querySelector('input[name="custom_config[aging_warning_label]"]').value = '<%= j @current_config.aging_warning_label %>';
      document.querySelector('input[name="custom_config[aging_danger_label]"]').value = '<%= j @current_config.aging_danger_label %>';

      toggleAgingOptions();
    }
  });

  // Initial state
  toggleAgingOptions();
});
</script>