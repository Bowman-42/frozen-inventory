<% if notice %>
  <div class="flash-notice"><%= notice %></div>
<% end %>

<div class="breadcrumb">
  <%= link_to "‚Üê Back to Dashboard", root_path, class: "back-link" %>
</div>

<div class="page-header">
  <h1>All Fridges</h1>
  <p>Browse all fridges and freezers in the system</p>

  <div class="action-buttons">
    <%= link_to "‚ûï New Fridge", new_location_path, class: "btn btn-success" %>
    <button type="button" id="print-selected-btn" class="btn btn-primary" disabled>üñ®Ô∏è Print Selected Barcodes</button>
  </div>

  <%= form_with url: search_locations_path, method: :get, local: true, class: "search-form" do |f| %>
    <%= f.text_field :q, placeholder: "Search fridges by name, barcode, or description...", value: params[:q], class: "search-input" %>
    <%= f.submit "Search", class: "btn btn-primary" %>
    <% if params[:q].present? %>
      <%= link_to "Clear", locations_path, class: "btn btn-secondary" %>
    <% end %>
  <% end %>
</div>

<div class="locations-list">
  <% if @locations.any? %>
    <%= form_tag print_barcodes_locations_path, method: :post, id: "barcode-print-form", target: "_blank" do %>
      <div class="locations-table">
        <table>
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all" />
                <label for="select-all">Select All</label>
              </th>
              <th>Fridge Name</th>
              <th>Barcode</th>
              <th>Total Items</th>
              <th>Recent Items</th>
            </tr>
          </thead>
          <tbody>
            <% @locations.each do |location| %>
              <tr>
                <td>
                  <%= check_box_tag "location_ids[]", location.id, false, class: "location-checkbox", id: "location_#{location.id}" %>
                </td>
                <td>
                  <%= link_to location.name, location_path(location.barcode), class: "location-link" %>
                  <% if location.description.present? %>
                    <br><small class="description"><%= location.description %></small>
                  <% end %>
                </td>
                <td class="barcode"><%= location.barcode %></td>
                <td class="quantity"><%= pluralize(location.total_items, 'item') %></td>
                <td class="recent-items">
                  <% if location.inventory_items.any? %>
                    <% location.inventory_items.includes(:item).limit(3).each do |inv_item| %>
                      <small class="item-preview"><%= inv_item.item.name %> (<%= inv_item.quantity %>)</small>
                    <% end %>
                  <% else %>
                    <span class="no-items">Empty</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% else %>
    <div class="empty-state">
      <h3>No fridges found</h3>
      <p>No fridges have been added to the system yet.</p>
      <%= link_to "Create your first fridge", new_location_path, class: "btn btn-success" %>
    </div>
  <% end %>
</div>

<script>
function initializeLocationsPrintButton() {
  function updateSelectAllState() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkedBoxes = document.querySelectorAll('.location-checkbox:checked');
    const allLocationCheckboxes = document.querySelectorAll('.location-checkbox');

    if (selectAllCheckbox && allLocationCheckboxes.length > 0) {
      selectAllCheckbox.checked = checkedBoxes.length === allLocationCheckboxes.length;
      selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allLocationCheckboxes.length;
    }
  }

  function updatePrintButton() {
    const printButton = document.getElementById('print-selected-btn');
    const checkedBoxes = document.querySelectorAll('.location-checkbox:checked');

    if (printButton) {
      printButton.disabled = checkedBoxes.length === 0;
      printButton.textContent = checkedBoxes.length > 0
        ? `üñ®Ô∏è Print ${checkedBoxes.length} Barcode${checkedBoxes.length === 1 ? '' : 's'}`
        : 'üñ®Ô∏è Print Selected Barcodes';
    }
  }

  // Use event delegation for dynamic content
  document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'select-all') {
      // Handle select all checkbox
      const isChecked = e.target.checked;
      document.querySelectorAll('.location-checkbox').forEach(function(checkbox) {
        checkbox.checked = isChecked;
      });
      updatePrintButton();
    } else if (e.target && e.target.classList.contains('location-checkbox')) {
      // Handle individual location checkbox
      updateSelectAllState();
      updatePrintButton();
    }
  });

  // Handle print button click
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'print-selected-btn') {
      const form = document.getElementById('barcode-print-form');
      if (form) {
        form.submit();
      }
    }
  });

  // Initialize button state after a short delay to ensure DOM is ready
  setTimeout(function() {
    updateSelectAllState();
    updatePrintButton();
  }, 50);
}

// Initialize on both DOMContentLoaded and Turbo events
document.addEventListener('DOMContentLoaded', initializeLocationsPrintButton);
document.addEventListener('turbo:load', initializeLocationsPrintButton);
document.addEventListener('turbo:render', initializeLocationsPrintButton);
</script>
