<% if notice %>
  <div class="flash-notice"><%= notice %></div>
<% end %>

<div class="breadcrumb">
  <%= link_to t('navigation.back_to_dashboard'), root_path, class: "back-link" %>
</div>

<div class="page-header">
  <h1><%= t('items.all_items') %></h1>
  <p><%= t('items.browse_all_items_desc') %></p>

  <div class="action-buttons">
    <%= link_to "üì¶ #{t('items.new_item')}", new_item_path, class: "btn btn-success" %>
    <button type="button" id="print-selected-btn" class="btn btn-primary" disabled>üñ®Ô∏è <%= t('items.print_selected') %></button>
    <button type="button" id="clear-selection-btn" class="btn btn-secondary" disabled>‚úï Clear Selection</button>
  </div>

  <div class="filters-section">
    <%= form_with url: search_items_path, method: :get, local: true, class: "search-form" do |f| %>
      <%= f.text_field :q, placeholder: t('items.search_placeholder'), value: params[:q], class: "search-input" %>
      <%= f.submit t('navigation.search'), class: "btn btn-primary" %>
      <% if params[:q].present? %>
        <%= link_to t('navigation.clear'), items_path, class: "btn btn-secondary" %>
      <% end %>
    <% end %>

    <div class="category-filter">
      <%= form_with url: items_path, method: :get, local: true, class: "filter-form" do |f| %>
        <%= f.collection_select :category_id, Category.ordered, :id, :name,
            { prompt: t('categories.all_categories'), selected: params[:category_id] },
            { class: "filter-select", onchange: "this.form.submit();" } %>
      <% end %>
    </div>
  </div>
</div>

<div class="items-list">
  <% if @items.any? %>
    <%= form_tag print_barcodes_items_path, method: :post, id: "barcode-print-form", target: "_blank" do %>
      <div class="items-table">
        <table>
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all" />
                <label for="select-all"><%= t('navigation.select_all') %></label>
              </th>
              <th><%= t('items.print_copies') %></th>
              <th class="sortable">
                <%= link_to items_path(sort: 'name', direction: (@sort_column == 'name' && @sort_direction == 'asc') ? 'desc' : 'asc', category_id: params[:category_id], q: params[:q]), class: "sort-link" do %>
                  <%= t('items.item_name') %>
                  <% if @sort_column == 'name' %>
                    <span class="sort-indicator <%= @sort_direction %>">
                      <%= @sort_direction == 'asc' ? '‚ñ≤' : '‚ñº' %>
                    </span>
                  <% end %>
                <% end %>
              </th>
              <th class="sortable">
                <%= link_to items_path(sort: 'category', direction: (@sort_column == 'category' && @sort_direction == 'asc') ? 'desc' : 'asc', category_id: params[:category_id], q: params[:q]), class: "sort-link" do %>
                  <%= t('items.category') %>
                  <% if @sort_column == 'category' %>
                    <span class="sort-indicator <%= @sort_direction %>">
                      <%= @sort_direction == 'asc' ? '‚ñ≤' : '‚ñº' %>
                    </span>
                  <% end %>
                <% end %>
              </th>
              <th class="sortable">
                <%= link_to items_path(sort: 'quantity', direction: (@sort_column == 'quantity' && @sort_direction == 'asc') ? 'desc' : 'asc', category_id: params[:category_id], q: params[:q]), class: "sort-link" do %>
                  <%= t('items.total_quantity') %>
                  <% if @sort_column == 'quantity' %>
                    <span class="sort-indicator <%= @sort_direction %>">
                      <%= @sort_direction == 'asc' ? '‚ñ≤' : '‚ñº' %>
                    </span>
                  <% end %>
                <% end %>
              </th>
              <th><%= t('items.oldest_storage') %></th>
              <th><%= t('items.locations') %></th>
              <th><%= t('common.actions') %></th>
            </tr>
          </thead>
          <tbody>
            <% @items.each do |item| %>
              <tr>
                <td>
                  <%= check_box_tag "item_ids[]", item.id, false, class: "item-checkbox", id: "item_#{item.id}" %>
                </td>
                <td class="print-copies">
                  <%= number_field_tag "copies[#{item.id}]", 1,
                      min: 1, max: 20,
                      class: "copy-quantity-input",
                      id: "copies_#{item.id}",
                      disabled: true %>
                </td>
                <td>
                  <%= link_to item.name, item_path(item.barcode), class: "item-link" %>
                  <% if item.description.present? %>
                    <br><small class="description"><%= item.description %></small>
                  <% end %>
                </td>
                <td class="category">
                  <% if item.category %>
                    <%= link_to item.category.name, category_path(item.category), class: "category-link" %>
                  <% else %>
                    <span class="no-category">Uncategorized</span>
                  <% end %>
                </td>
                <td class="quantity"><%= item.total_quantity %></td>
                <td class="oldest-storage">
                  <% if aging_enabled? %>
                    <% oldest_inventory = @oldest_inventory_items[item.id]&.first %>
                    <% if oldest_inventory %>
                      <% days_stored = (Date.current - oldest_inventory.added_at.to_date).to_i %>
                      <span class="storage-duration-badge <%= aging_css_class(days_stored) %>">
                        <%= pluralize(days_stored, 'day') %>
                      </span>
                      <br>
                      <small>in <%= link_to oldest_inventory.location.name, location_path(oldest_inventory.location.barcode), class: "location-link" %></small>
                    <% end %>
                  <% end %>
                </td>
                <td class="locations">
                  <% if item.locations.any? %>
                    <%= item.locations.map(&:name).join(", ") %>
                  <% else %>
                    <span class="no-locations">Not in any <%= location_term.downcase %></span>
                  <% end %>
                </td>
                <td class="actions">
                  <%= link_to "Edit", edit_item_path(item.barcode), class: "btn btn-sm btn-secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <%= paginate @items %>
  <% else %>
    <div class="empty-state">
      <h3>No items found</h3>
      <p>No items have been added to the system yet.</p>
    </div>
  <% end %>
</div>

<!-- Print Options Modal -->
<div id="print-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Print Label Options</h3>
      <span class="modal-close">&times;</span>
    </div>
    <div class="modal-body">
      <div class="print-summary">
        <p id="modal-print-summary">Ready to print labels</p>
      </div>

      <div class="sheet-type-selector">
        <label class="sheet-type-option">
          <input type="radio" name="modal_sheet_type" value="fresh" checked class="sheet-type-radio">
          <span class="radio-label">Fresh/Flipped Sheet</span>
          <small class="help-text">Use for new sheets or after flipping used sheets</small>
        </label>
        <label class="sheet-type-option">
          <input type="radio" name="modal_sheet_type" value="partial" class="sheet-type-radio">
          <span class="radio-label">Partial Sheet - Choose Positions</span>
          <small class="help-text">Select specific positions on partially used sheets</small>
        </label>
      </div>

      <div class="position-selector" style="display: none;" id="modal-position-selector">
        <div class="position-selector-header">
          <h4>Select Label Positions (2√ó7 grid)</h4>
          <div class="position-info">
            <span id="modal-position-counter">0 positions selected</span>
            <span id="modal-label-counter">‚Ä¢ 0 labels to print</span>
          </div>
        </div>

        <div class="label-position-grid">
          <% (1..14).each do |position| %>
            <label class="position-checkbox <%= position <= 7 ? 'left-column' : 'right-column' %>">
              <input type="checkbox" name="modal_label_positions[]" value="<%= position %>" class="modal-position-input" id="modal_position_<%= position %>">
              <span class="position-number"><%= position %></span>
            </label>
          <% end %>
        </div>

        <div class="quick-presets">
          <button type="button" class="preset-btn" onclick="selectModalPositions([1,2,3,4,5,6])">First 6</button>
          <button type="button" class="preset-btn" onclick="selectModalPositions([9,10,11,12,13,14])">Last 6</button>
          <button type="button" class="preset-btn" onclick="selectModalPositions([1,2,3,4,5,6,9,10])">Skip Middle (8)</button>
          <button type="button" class="preset-btn" onclick="clearAllModalPositions()">Clear All</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
      <button type="button" class="btn btn-primary modal-print">üñ®Ô∏è Print Labels</button>
    </div>
  </div>
</div>

<!-- Floating Selection Counter -->
<div id="floating-selection-counter" class="floating-selection-status" style="display: none;">
  <div class="selection-info">
    <span id="floating-selection-text">0 items selected</span>
  </div>
</div>

<script type="module">
  import { initializeItemSelection } from "item_selection_manager";

  function initializeWithPrintCheck() {
    initializeItemSelection();

    // Clear selection if printing was successful
    <% if @print_success %>
      // Small delay to ensure the manager is initialized
      setTimeout(() => {
        if (window.itemSelectionManager) {
          window.itemSelectionManager.clearSelection();

          // Show success message
          const successMessage = document.createElement('div');
          successMessage.className = 'alert alert-success';
          successMessage.style.position = 'fixed';
          successMessage.style.top = '20px';
          successMessage.style.right = '20px';
          successMessage.style.zIndex = '1001';
          successMessage.style.padding = '10px 15px';
          successMessage.style.borderRadius = '4px';
          successMessage.style.backgroundColor = '#d4edda';
          successMessage.style.color = '#155724';
          successMessage.style.border = '1px solid #c3e6cb';
          successMessage.textContent = 'Labels printed successfully! Selection cleared.';

          document.body.appendChild(successMessage);

          // Remove message after 3 seconds
          setTimeout(() => {
            successMessage.remove();
          }, 3000);
        }
      }, 100);
    <% end %>
  }

  // Initialize immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeWithPrintCheck);
  } else {
    initializeWithPrintCheck();
  }

  // Also initialize on Turbo navigation
  document.addEventListener('turbo:load', initializeWithPrintCheck);
  document.addEventListener('turbo:render', initializeWithPrintCheck);


  // Global functions for modal preset buttons
  window.selectModalPositions = function(positions) {
    if (window.itemSelectionManager) {
      window.itemSelectionManager.selectModalPositions(positions);
    }
  };

  window.clearAllModalPositions = function() {
    // Clear all modal checkboxes
    document.querySelectorAll('.modal-position-input').forEach(cb => cb.checked = false);
    const positionCounter = document.getElementById('modal-position-counter');
    if (positionCounter) positionCounter.textContent = '0 positions selected';
  };
</script>

<style>
/* Modal Styles */
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  backdrop-filter: blur(2px);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #e9ecef;
}

.modal-header h3 {
  margin: 0;
  color: #212529;
  font-size: 20px;
  font-weight: 600;
}

.modal-close {
  color: #6c757d;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s;
}

.modal-close:hover {
  color: #495057;
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  padding: 16px 24px;
  border-top: 1px solid #e9ecef;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

.print-summary {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  text-align: center;
}

.print-summary p {
  margin: 0;
  font-size: 16px;
  font-weight: 500;
  color: #495057;
}

/* Print Options */
.print-options {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.print-options h3 {
  margin: 0 0 15px 0;
  color: #495057;
  font-size: 18px;
}

.sheet-type-selector {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.sheet-type-option {
  display: flex;
  flex-direction: column;
  padding: 15px;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  flex: 1;
}

.sheet-type-option:hover {
  border-color: #007bff;
  background: #f0f8ff;
}

.sheet-type-option input[type="radio"]:checked + .radio-label {
  color: #007bff;
  font-weight: bold;
}

.sheet-type-option input[type="radio"]:checked {
  border-color: #007bff;
}

.sheet-type-option .radio-label {
  font-size: 16px;
  margin-bottom: 5px;
  font-weight: 500;
}

.sheet-type-option .help-text {
  color: #6c757d;
  font-size: 13px;
  line-height: 1.3;
}

.position-selector {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
}

.position-selector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.position-selector-header h4 {
  margin: 0;
  color: #495057;
}

.position-info {
  display: flex;
  gap: 10px;
  font-size: 14px;
  color: #6c757d;
}

.label-position-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
  max-width: 300px;
}

.position-checkbox {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 40px;
  border: 2px solid #dee2e6;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  background: white;
}

.position-checkbox:hover {
  border-color: #007bff;
  background: #f0f8ff;
}

.position-checkbox .position-input {
  position: absolute;
  opacity: 0;
  cursor: pointer;
}

.position-checkbox .position-input:checked + .position-number {
  background: #007bff;
  color: white;
}

.position-checkbox .position-input:checked {
  background: #007bff;
}

.position-checkbox.left-column {
  order: calc(var(--position) * 2 - 1);
}

.position-checkbox.right-column {
  order: calc((var(--position) - 7) * 2);
}

.position-number {
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
  border-radius: 4px;
  background: #f8f9fa;
  color: #495057;
  transition: all 0.2s;
}

.quick-presets {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.preset-btn {
  padding: 8px 16px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  transition: background-color 0.2s;
}

.preset-btn:hover {
  background: #5a6268;
}

.preset-btn:active {
  background: #495057;
}

.filters-section {
  display: flex;
  gap: 20px;
  align-items: flex-end;
  margin-bottom: 20px;
}

.search-form {
  flex: 1;
}

.category-filter {
  min-width: 200px;
}

.filter-form {
  margin: 0;
}

.filter-select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: white;
  font-size: 14px;
}

.category-link {
  color: #007bff;
  text-decoration: none;
  font-size: 0.9em;
}

.category-link:hover {
  text-decoration: underline;
}

.no-category {
  color: #6c757d;
  font-style: italic;
  font-size: 0.9em;
}

/* Floating Selection Counter */
.floating-selection-status {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  padding: 12px 16px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 1000;
  max-width: 250px;
  animation: slideInUp 0.3s ease-out;
}

.selection-info {
  font-size: 14px;
  text-align: center;
}

@keyframes slideInUp {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsive design for mobile */
@media (max-width: 768px) {
  .floating-selection-status {
    bottom: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    padding: 12px 15px;
  }

  .selection-info {
    font-size: 13px;
  }

  #floating-selection-text {
    min-width: auto;
  }
}
</style>
