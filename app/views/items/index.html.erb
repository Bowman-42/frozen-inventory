<% if notice %>
  <div class="flash-notice"><%= notice %></div>
<% end %>

<div class="breadcrumb">
  <%= link_to "‚Üê Back to Dashboard", root_path, class: "back-link" %>
</div>

<div class="page-header">
  <h1>All Items</h1>
  <p>Browse all items in the inventory system</p>

  <div class="action-buttons">
    <%= link_to "üì¶ New Item", new_item_path, class: "btn btn-success" %>
    <button type="button" id="print-selected-btn" class="btn btn-primary" disabled>üñ®Ô∏è Print Selected Barcodes</button>
  </div>

  <div class="filters-section">
    <%= form_with url: search_items_path, method: :get, local: true, class: "search-form" do |f| %>
      <%= f.text_field :q, placeholder: "Search items by name, barcode, or description...", value: params[:q], class: "search-input" %>
      <%= f.submit "Search", class: "btn btn-primary" %>
      <% if params[:q].present? %>
        <%= link_to "Clear", items_path, class: "btn btn-secondary" %>
      <% end %>
    <% end %>

    <div class="category-filter">
      <%= form_with url: items_path, method: :get, local: true, class: "filter-form" do |f| %>
        <%= f.collection_select :category_id, Category.ordered, :id, :name,
            { prompt: "All Categories", selected: params[:category_id] },
            { class: "filter-select", onchange: "this.form.submit();" } %>
      <% end %>
    </div>
  </div>
</div>

<div class="items-list">
  <% if @items.any? %>
    <%= form_tag print_barcodes_items_path, method: :post, id: "barcode-print-form", target: "_blank" do %>
      <div class="items-table">
        <table>
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all" />
                <label for="select-all">Select All</label>
              </th>
              <th>Item Name</th>
              <th>Category</th>
              <th>Barcode</th>
              <th>Total Quantity</th>
              <th>Locations</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @items.each do |item| %>
              <tr>
                <td>
                  <%= check_box_tag "item_ids[]", item.id, false, class: "item-checkbox", id: "item_#{item.id}" %>
                </td>
                <td>
                  <%= link_to item.name, item_path(item.barcode), class: "item-link" %>
                  <% if item.description.present? %>
                    <br><small class="description"><%= item.description %></small>
                  <% end %>
                </td>
                <td class="category">
                  <% if item.category %>
                    <%= link_to item.category.name, category_path(item.category), class: "category-link" %>
                  <% else %>
                    <span class="no-category">Uncategorized</span>
                  <% end %>
                </td>
                <td class="barcode"><%= item.barcode %></td>
                <td class="quantity"><%= item.total_quantity %></td>
                <td class="locations">
                  <% if item.locations.any? %>
                    <%= item.locations.map(&:name).join(", ") %>
                  <% else %>
                    <span class="no-locations">Not in any fridge</span>
                  <% end %>
                </td>
                <td class="actions">
                  <%= link_to "Edit", edit_item_path(item.barcode), class: "btn btn-sm btn-secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <%= paginate @items %>
  <% else %>
    <div class="empty-state">
      <h3>No items found</h3>
      <p>No items have been added to the system yet.</p>
    </div>
  <% end %>
</div>

<script>
function initializeItemsPrintButton() {
  function updateSelectAllState() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
    const allItemCheckboxes = document.querySelectorAll('.item-checkbox');

    if (selectAllCheckbox && allItemCheckboxes.length > 0) {
      selectAllCheckbox.checked = checkedBoxes.length === allItemCheckboxes.length;
      selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allItemCheckboxes.length;
    }
  }

  function updatePrintButton() {
    const printButton = document.getElementById('print-selected-btn');
    const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');

    if (printButton) {
      printButton.disabled = checkedBoxes.length === 0;
      printButton.textContent = checkedBoxes.length > 0
        ? `üñ®Ô∏è Print ${checkedBoxes.length} Barcode${checkedBoxes.length === 1 ? '' : 's'}`
        : 'üñ®Ô∏è Print Selected Barcodes';
    }
  }

  // Use event delegation for dynamic content
  document.addEventListener('change', function(e) {
    if (e.target && e.target.id === 'select-all') {
      // Handle select all checkbox
      const isChecked = e.target.checked;
      document.querySelectorAll('.item-checkbox').forEach(function(checkbox) {
        checkbox.checked = isChecked;
      });
      updatePrintButton();
    } else if (e.target && e.target.classList.contains('item-checkbox')) {
      // Handle individual item checkbox
      updateSelectAllState();
      updatePrintButton();
    }
  });

  // Handle print button click
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'print-selected-btn') {
      const form = document.getElementById('barcode-print-form');
      if (form) {
        form.submit();
      }
    }
  });

  // Initialize button state after a short delay to ensure DOM is ready
  setTimeout(function() {
    updateSelectAllState();
    updatePrintButton();
  }, 50);
}

// Initialize on both DOMContentLoaded and Turbo events
document.addEventListener('DOMContentLoaded', initializeItemsPrintButton);
document.addEventListener('turbo:load', initializeItemsPrintButton);
document.addEventListener('turbo:render', initializeItemsPrintButton);
</script>

<style>
.filters-section {
  display: flex;
  gap: 20px;
  align-items: flex-end;
  margin-bottom: 20px;
}

.search-form {
  flex: 1;
}

.category-filter {
  min-width: 200px;
}

.filter-form {
  margin: 0;
}

.filter-select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: white;
  font-size: 14px;
}

.category-link {
  color: #007bff;
  text-decoration: none;
  font-size: 0.9em;
}

.category-link:hover {
  text-decoration: underline;
}

.no-category {
  color: #6c757d;
  font-style: italic;
  font-size: 0.9em;
}
</style>
