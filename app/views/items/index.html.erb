<% if notice %>
  <div class="flash-notice"><%= notice %></div>
<% end %>

<div class="breadcrumb">
  <%= link_to t('navigation.back_to_dashboard'), root_path, class: "back-link" %>
</div>

<div class="page-header">
  <h1><%= t('items.all_items') %></h1>
  <p><%= t('items.browse_all_items_desc') %></p>

  <div class="action-buttons">
    <%= link_to "üì¶ #{t('items.new_item')}", new_item_path, class: "btn btn-success" %>
    <button type="button" id="print-selected-btn" class="btn btn-primary" disabled>üñ®Ô∏è <%= t('items.print_selected') %></button>
  </div>

  <div class="filters-section">
    <%= form_with url: search_items_path, method: :get, local: true, class: "search-form" do |f| %>
      <%= f.text_field :q, placeholder: t('items.search_placeholder'), value: params[:q], class: "search-input" %>
      <%= f.submit t('navigation.search'), class: "btn btn-primary" %>
      <% if params[:q].present? %>
        <%= link_to t('navigation.clear'), items_path, class: "btn btn-secondary" %>
      <% end %>
    <% end %>

    <div class="category-filter">
      <%= form_with url: items_path, method: :get, local: true, class: "filter-form" do |f| %>
        <%= f.collection_select :category_id, Category.ordered, :id, :name,
            { prompt: t('categories.all_categories'), selected: params[:category_id] },
            { class: "filter-select", onchange: "this.form.submit();" } %>
      <% end %>
    </div>
  </div>
</div>

<div class="items-list">
  <% if @items.any? %>
    <%= form_tag print_barcodes_items_path, method: :post, id: "barcode-print-form", target: "_blank" do %>
      <div class="items-table">
        <table>
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="select-all" />
                <label for="select-all"><%= t('navigation.select_all') %></label>
              </th>
              <th><%= t('items.print_copies') %></th>
              <th class="sortable">
                <%= link_to items_path(sort: 'name', direction: (@sort_column == 'name' && @sort_direction == 'asc') ? 'desc' : 'asc', category_id: params[:category_id], q: params[:q]), class: "sort-link" do %>
                  <%= t('items.item_name') %>
                  <% if @sort_column == 'name' %>
                    <span class="sort-indicator <%= @sort_direction %>">
                      <%= @sort_direction == 'asc' ? '‚ñ≤' : '‚ñº' %>
                    </span>
                  <% end %>
                <% end %>
              </th>
              <th class="sortable">
                <%= link_to items_path(sort: 'category', direction: (@sort_column == 'category' && @sort_direction == 'asc') ? 'desc' : 'asc', category_id: params[:category_id], q: params[:q]), class: "sort-link" do %>
                  <%= t('items.category') %>
                  <% if @sort_column == 'category' %>
                    <span class="sort-indicator <%= @sort_direction %>">
                      <%= @sort_direction == 'asc' ? '‚ñ≤' : '‚ñº' %>
                    </span>
                  <% end %>
                <% end %>
              </th>
              <th class="sortable">
                <%= link_to items_path(sort: 'quantity', direction: (@sort_column == 'quantity' && @sort_direction == 'asc') ? 'desc' : 'asc', category_id: params[:category_id], q: params[:q]), class: "sort-link" do %>
                  <%= t('items.total_quantity') %>
                  <% if @sort_column == 'quantity' %>
                    <span class="sort-indicator <%= @sort_direction %>">
                      <%= @sort_direction == 'asc' ? '‚ñ≤' : '‚ñº' %>
                    </span>
                  <% end %>
                <% end %>
              </th>
              <th><%= t('items.oldest_storage') %></th>
              <th><%= t('items.locations') %></th>
              <th><%= t('common.actions') %></th>
            </tr>
          </thead>
          <tbody>
            <% @items.each do |item| %>
              <tr>
                <td>
                  <%= check_box_tag "item_ids[]", item.id, false, class: "item-checkbox", id: "item_#{item.id}" %>
                </td>
                <td class="print-copies">
                  <%= number_field_tag "copies[#{item.id}]", 1,
                      min: 1, max: 20,
                      class: "copy-quantity-input",
                      id: "copies_#{item.id}",
                      disabled: true %>
                </td>
                <td>
                  <%= link_to item.name, item_path(item.barcode), class: "item-link" %>
                  <% if item.description.present? %>
                    <br><small class="description"><%= item.description %></small>
                  <% end %>
                </td>
                <td class="category">
                  <% if item.category %>
                    <%= link_to item.category.name, category_path(item.category), class: "category-link" %>
                  <% else %>
                    <span class="no-category">Uncategorized</span>
                  <% end %>
                </td>
                <td class="quantity"><%= item.total_quantity %></td>
                <td class="oldest-storage">
                  <% if aging_enabled? %>
                    <% oldest_inventory = @oldest_inventory_items[item.id]&.first %>
                    <% if oldest_inventory %>
                      <% days_stored = (Date.current - oldest_inventory.added_at.to_date).to_i %>
                      <span class="storage-duration-badge <%= aging_css_class(days_stored) %>">
                        <%= pluralize(days_stored, 'day') %>
                      </span>
                      <br>
                      <small>in <%= link_to oldest_inventory.location.name, location_path(oldest_inventory.location.barcode), class: "location-link" %></small>
                    <% end %>
                  <% end %>
                </td>
                <td class="locations">
                  <% if item.locations.any? %>
                    <%= item.locations.map(&:name).join(", ") %>
                  <% else %>
                    <span class="no-locations">Not in any <%= location_term.downcase %></span>
                  <% end %>
                </td>
                <td class="actions">
                  <%= link_to "Edit", edit_item_path(item.barcode), class: "btn btn-sm btn-secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

    <%= paginate @items %>
  <% else %>
    <div class="empty-state">
      <h3>No items found</h3>
      <p>No items have been added to the system yet.</p>
    </div>
  <% end %>
</div>

<!-- Floating Selection Counter -->
<div id="floating-selection-counter" class="floating-selection-status" style="display: none;">
  <div class="selection-info">
    <span id="floating-selection-text">0 items selected</span>
    <button id="floating-print-btn" class="btn btn-primary btn-sm">üñ®Ô∏è Print</button>
    <button id="floating-clear-btn" class="btn btn-secondary btn-sm">‚úï</button>
  </div>
</div>

<script type="module">
  import { initializeItemSelection } from "item_selection_manager";

  function initializeWithPrintCheck() {
    initializeItemSelection();

    // Clear selection if printing was successful
    <% if @print_success %>
      // Small delay to ensure the manager is initialized
      setTimeout(() => {
        if (window.itemSelectionManager) {
          window.itemSelectionManager.clearSelection();

          // Show success message
          const successMessage = document.createElement('div');
          successMessage.className = 'alert alert-success';
          successMessage.style.position = 'fixed';
          successMessage.style.top = '20px';
          successMessage.style.right = '20px';
          successMessage.style.zIndex = '1001';
          successMessage.style.padding = '10px 15px';
          successMessage.style.borderRadius = '4px';
          successMessage.style.backgroundColor = '#d4edda';
          successMessage.style.color = '#155724';
          successMessage.style.border = '1px solid #c3e6cb';
          successMessage.textContent = 'Labels printed successfully! Selection cleared.';

          document.body.appendChild(successMessage);

          // Remove message after 3 seconds
          setTimeout(() => {
            successMessage.remove();
          }, 3000);
        }
      }, 100);
    <% end %>
  }

  // Initialize immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeWithPrintCheck);
  } else {
    initializeWithPrintCheck();
  }

  // Also initialize on Turbo navigation
  document.addEventListener('turbo:load', initializeWithPrintCheck);
  document.addEventListener('turbo:render', initializeWithPrintCheck);
</script>

<style>
.filters-section {
  display: flex;
  gap: 20px;
  align-items: flex-end;
  margin-bottom: 20px;
}

.search-form {
  flex: 1;
}

.category-filter {
  min-width: 200px;
}

.filter-form {
  margin: 0;
}

.filter-select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: white;
  font-size: 14px;
}

.category-link {
  color: #007bff;
  text-decoration: none;
  font-size: 0.9em;
}

.category-link:hover {
  text-decoration: underline;
}

.no-category {
  color: #6c757d;
  font-style: italic;
  font-size: 0.9em;
}

/* Floating Selection Counter */
.floating-selection-status {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 1000;
  max-width: 300px;
  animation: slideInUp 0.3s ease-out;
}

.selection-info {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  flex-wrap: wrap;
}

#floating-selection-text {
  flex: 1;
  min-width: 120px;
}

.floating-selection-status .btn {
  font-size: 12px;
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.floating-selection-status .btn-primary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.floating-selection-status .btn-primary:hover {
  background: rgba(255, 255, 255, 0.3);
}

.floating-selection-status .btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  font-weight: bold;
}

.floating-selection-status .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

@keyframes slideInUp {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Responsive design for mobile */
@media (max-width: 768px) {
  .floating-selection-status {
    bottom: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    padding: 12px 15px;
  }

  .selection-info {
    font-size: 13px;
  }

  #floating-selection-text {
    min-width: auto;
  }
}
</style>
